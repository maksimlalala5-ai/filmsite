<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>CINEMATE ¬∑ –ò–¥–µ–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0b0e14; 
            color: white; 
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nick-section {
            display: flex;
            gap: 8px;
            align-items: center;
            background: #1a1f2b;
            padding: 8px 15px;
            border-radius: 50px;
            border: 1px solid #333;
        }

        .nick-section label {
            font-size: 13px;
            color: #888;
            white-space: nowrap;
        }

        .nick-display {
            font-size: 13px;
            color: #5f7cff;
            font-weight: 600;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nick-input {
            padding: 6px 10px;
            border-radius: 20px;
            border: 1px solid #333;
            background: #0b0e14;
            color: white;
            outline: none;
            font-size: 13px;
            width: 140px;
            display: none;
        }

        .nick-input:focus {
            border-color: #5f7cff;
        }

        .nick-edit-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 13px;
            padding: 4px 8px;
        }

        .nick-edit-btn:hover {
            color: #5f7cff;
        }

        .nick-save-btn, .nick-cancel-btn {
            background: #5f7cff;
            color: #fff;
            border: none;
            padding: 6px 10px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            display: none;
        }

        .nick-cancel-btn {
            background: #2a2f3a;
        }

        .nick-save-btn:hover {
            background: #738dff;
        }

        .nick-cancel-btn:hover {
            background: #3a3f4a;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 600;
        }
        
        .logo i {
            color: #5f7cff;
            margin-right: 8px;
        }
        
        .connection-status {
            background: #1a1f2b;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            border: 1px solid #333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #4caf50; box-shadow: 0 0 10px #4caf50; }
        .status-disconnected { background: #ff6b6b; }
        .status-connecting { background: #ffaa00; }

        .message-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #5f7cff;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            animation: slideInRight 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(95, 124, 255, 0.3);
            z-index: 1000;
            display: none;
        }

        .message-badge.show {
            display: block;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .message-badge.hide {
            animation: fadeOut 0.3s ease forwards;
        }
        
        .guide {
            background: #1a1f2b;
            border-radius: 16px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid #5f7cff;
        }
        
        .guide h4 {
            color: #5f7cff;
            margin-bottom: 10px;
        }
        
        .guide ol {
            margin-left: 20px;
            color: #aaa;
            line-height: 1.6;
        }
        
        .room-section {
            background: #1a1f2b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .room-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #5f7cff;
        }
        
        .room-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .room-btn {
            background: #5f7cff;
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }
        
        .room-btn.secondary {
            background: #2a2f3a;
        }
        
        .room-btn.danger {
            background: #ff6b6b;
        }
        
        .room-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        
        .room-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .room-input {
            background: #0b0e14;
            border: 1px solid #333;
            color: white;
            padding: 12px 15px;
            border-radius: 50px;
            width: 250px;
            outline: none;
        }
        
        .room-input:focus {
            border-color: #5f7cff;
        }
        
        .room-info {
            margin-top: 15px;
            padding: 15px;
            background: #0b0e14;
            border-radius: 12px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .room-id-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1a1f2b;
            padding: 8px 16px;
            border-radius: 50px;
        }
        
        .room-id {
            font-family: monospace;
            font-size: 18px;
            color: #5f7cff;
            font-weight: 600;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
        }
        
        .copy-btn:hover {
            color: #5f7cff;
        }
        
        .users-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .user-badge {
            background: #2a2f3a;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-badge.host {
            background: #5f7cff;
        }
        
        .user-badge i {
            font-size: 12px;
        }
        
        .url-section {
            margin-bottom: 20px;
        }
        
        .url-box {
            display: flex;
            gap: 10px;
            background: #1a1f2b;
            border-radius: 50px;
            padding: 5px;
            border: 1px solid #333;
        }
        
        .url-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 15px 20px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .url-box button {
            background: #5f7cff;
            border: none;
            border-radius: 50px;
            padding: 0 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        
        .url-box button:hover {
            background: #738dff;
        }
        
        .supported-sites {
            display: flex;
            gap: 15px;
            margin: 10px 0 0 15px;
            color: #888;
            font-size: 13px;
            flex-wrap: wrap;
        }
        
        .supported-sites span i {
            margin-right: 5px;
        }
        
        .supported-sites .vk { color: #4a76a8; }
        .supported-sites .rutube { color: #7cd3ff; }
        .supported-sites .ok { color: #ee8208; }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            height: calc(100vh - 300px);
            min-height: 500px;
        }
        
        .player-container {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        
        .player-header {
            padding: 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-header h3 {
            font-size: 16px;
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }

        .sync-indicator {
            background: rgba(95, 124, 255, 0.2);
            color: #5f7cff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            border: 1px solid #5f7cff;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-indicator.synced {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border-color: #4caf50;
        }

        .sync-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #5f7cff;
            animation: pulse 1s infinite;
        }

        .sync-indicator.synced .sync-dot {
            background: #4caf50;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .player-wrapper {
            flex: 1;
            background: #000;
            position: relative;
        }
        
        #videoPlayer {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .native-video-player {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .native-video-player video {
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        .player-controls-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            z-index: 20;
            pointer-events: none;
            flex-wrap: wrap;
        }
        
        .player-controls-overlay button {
            pointer-events: auto;
        }
        
        .control-btn {
            background: rgba(95, 124, 255, 0.9);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        
        .control-btn:hover {
            background: #5f7cff;
            transform: scale(1.05);
        }
        
        .control-btn.secondary {
            background: rgba(42, 47, 58, 0.9);
        }
        
        .sync-status {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 13px;
            z-index: 30;
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        .chat-container {
            background: #1a1f2b;
            border-radius: 16px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            font-weight: 600;
            color: #5f7cff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online-count {
            background: #2a2f3a;
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 12px;
            color: #aaa;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.own {
            background: #5f7cff;
            align-self: flex-end;
        }
        
        .message.other {
            background: #2a2f3a;
            align-self: flex-start;
        }
        
        .message.system {
            background: #333;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-style: italic;
            opacity: 0.8;
            font-size: 12px;
        }
        
        .message .sender {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .message .text {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message .time {
            font-size: 10px;
            opacity: 0.5;
            text-align: right;
            margin-top: 4px;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: #0b0e14;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 25px;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #5f7cff;
        }
        
        .chat-send-btn {
            background: #5f7cff;
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .chat-send-btn:hover:not(:disabled) {
            background: #738dff;
            transform: scale(1.1);
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            color: #888;
            font-size: 12px;
            padding: 5px 15px;
            font-style: italic;
        }
        
        .sync-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #5f7cff;
            width: 0%;
            transition: width 0.3s;
        }

        /* –£–õ–£–ß–®–ï–ù–ù–´–ô –ú–û–ë–ò–õ–¨–ù–´–ô –î–ò–ó–ê–ô–ù */
        @media (max-width: 1024px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .nick-section {
                width: 100%;
                justify-content: space-between;
            }

            .nick-input {
                width: 100%;
            }

            .room-info {
                flex-direction: column;
                align-items: stretch;
            }

            .users-list {
                width: 100%;
            }

            .url-box {
                flex-direction: column;
            }

            .url-box button {
                width: 100%;
            }

            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }

            .player-container {
                height: 50vh;
                min-height: 300px;
            }

            .chat-container {
                height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            .container { padding: 12px; }

            .header {
                margin-bottom: 16px;
            }

            .logo {
                font-size: 20px;
            }

            .nick-section {
                padding: 6px 12px;
                font-size: 12px;
            }

            .nick-input {
                width: calc(100% - 40px);
                font-size: 12px;
                padding: 8px;
            }

            .nick-edit-btn {
                padding: 4px;
            }

            .room-section {
                padding: 16px;
                margin-bottom: 16px;
            }

            .room-title {
                font-size: 16px;
            }

            .room-controls {
                gap: 8px;
            }

            .room-btn {
                padding: 10px 16px;
                font-size: 12px;
                flex: 1;
                min-width: 45%;
            }

            .room-input {
                width: 100%;
                font-size: 14px;
            }

            .room-info {
                padding: 12px;
                gap: 8px;
            }

            .room-id-box {
                padding: 6px 12px;
            }

            .room-id {
                font-size: 16px;
            }

            .users-list {
                gap: 8px;
            }

            .user-badge {
                padding: 4px 10px;
                font-size: 12px;
            }

            .url-box {
                border-radius: 20px;
                padding: 4px;
                gap: 8px;
            }

            .url-box input {
                padding: 12px 15px;
                font-size: 14px;
            }

            .url-box button {
                padding: 0 20px;
                font-size: 12px;
            }

            .supported-sites {
                margin: 8px 0 0 12px;
                gap: 10px;
                font-size: 12px;
            }

            .main-content {
                gap: 16px;
            }

            .player-header h3 {
                font-size: 14px;
            }

            .player-controls-overlay {
                bottom: 15px;
                left: 15px;
                right: 15px;
                gap: 8px;
            }

            .control-btn {
                padding: 10px 16px;
                font-size: 12px;
                gap: 6px;
            }

            .control-btn i {
                font-size: 14px;
            }

            .chat-header {
                padding: 12px;
                font-size: 14px;
            }

            .online-count {
                padding: 2px 8px;
                font-size: 11px;
            }

            .chat-messages {
                padding: 12px;
                gap: 8px;
            }

            .message {
                max-width: 90%;
                padding: 6px 10px;
                font-size: 13px;
            }

            .message .sender {
                font-size: 11px;
            }

            .message .text {
                font-size: 13px;
            }

            .message .time {
                font-size: 9px;
            }

            .chat-input-area {
                padding: 12px;
                gap: 8px;
            }

            .chat-input {
                padding: 10px;
                font-size: 14px;
            }

            .chat-send-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .container { padding: 10px; }

            .header {
                gap: 10px;
            }

            .logo {
                font-size: 18px;
            }

            .connection-status {
                padding: 6px 12px;
                font-size: 12px;
            }

            .nick-section {
                width: 100%;
                padding: 6px 10px;
            }

            .nick-display {
                max-width: 100px;
                font-size: 12px;
            }

            .room-section {
                padding: 12px;
            }

            .room-controls {
                flex-direction: column;
            }

            .room-btn {
                width: 100%;
                padding: 10px;
            }

            .room-input {
                width: 100%;
            }

            .room-info {
                flex-direction: column;
                padding: 10px;
            }

            .users-list {
                width: 100%;
                gap: 6px;
            }

            .user-badge {
                flex: 1;
                justify-content: center;
                font-size: 11px;
            }

            .url-box {
                flex-direction: column;
                padding: 3px;
            }

            .url-box input {
                padding: 10px;
            }

            .url-box button {
                width: 100%;
                padding: 10px;
            }

            .supported-sites {
                margin: 6px 0 0 0;
                padding: 0 10px;
                flex-direction: column;
                gap: 6px;
            }

            .player-container {
                height: 45vh;
                min-height: 250px;
            }

            .chat-container {
                height: 350px;
            }

            .guide {
                padding: 12px 15px;
            }

            .guide h4 {
                font-size: 14px;
            }

            .guide ol {
                margin-left: 18px;
                font-size: 12px;
            }

            .message-badge {
                bottom: 15px;
                right: 15px;
                padding: 10px 15px;
                font-size: 12px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-film"></i> CINEMATE
            </div>
            <div class="nick-section">
                <label>–ù–∏–∫:</label>
                <span class="nick-display" id="nickDisplay"></span>
                <input type="text" class="nick-input" id="nickInput">
                <button class="nick-edit-btn" id="nickEditBtn" title="–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="nick-save-btn" id="nickSaveBtn">‚úì</button>
                <button class="nick-cancel-btn" id="nickCancelBtn">‚úï</button>
            </div>
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                <span id="statusText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É</span>
            </div>
        </div>
        
        <div class="guide">
            <h4><i class="fas fa-info-circle"></i> –ö–∞–∫ —Å–º–æ—Ç—Ä–µ—Ç—å –≤–º–µ—Å—Ç–µ:</h4>
            <ol>
                <li><strong>–°–æ–∑–¥–∞—Ç–µ–ª—å</strong> –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É" ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ID –ø–æ–¥—Ä—É–≥–µ</li>
                <li><strong>–°–æ–∑–¥–∞—Ç–µ–ª—å</strong> –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "–ó–∞–≥—Ä—É–∑–∏—Ç—å"</li>
                <li><strong>–ü–æ–¥—Ä—É–≥–∞</strong> –≤–≤–æ–¥–∏—Ç ID –∫–æ–º–Ω–∞—Ç—ã ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"</li>
                <li>–û–±–∞ –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–∏–¥–µ–æ - –≤—Å—ë —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                <li>–û–±—â–∞–π—Ç–µ—Å—å –≤ —á–∞—Ç–µ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞!</li>
            </ol>
        </div>
        
        <div class="room-section">
            <div class="room-title">
                <i class="fas fa-users"></i> –ö–æ–º–Ω–∞—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            </div>
            <div class="room-controls">
                <button class="room-btn" id="createRoomBtn">
                    <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                </button>
                <input type="text" class="room-input" id="roomIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã">
                <button class="room-btn secondary" id="joinRoomBtn">
                    <i class="fas fa-door-open"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                </button>
                <button class="room-btn danger" id="leaveRoomBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> –ü–æ–∫–∏–Ω—É—Ç—å
                </button>
            </div>
            
            <div class="room-info" id="roomInfo" style="display: none;">
                <div class="room-id-box">
                    <i class="fas fa-door-open"></i>
                    <span class="room-id" id="currentRoomId"></span>
                    <button class="copy-btn" id="copyRoomIdBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
                <div class="users-list" id="usersList">
                    <div class="user-badge host" id="hostBadge">
                        <i class="fas fa-crown"></i> <span id="hostName">–•–æ—Å—Ç</span>
                    </div>
                    <div class="user-badge" id="guestBadge" style="display: none;">
                        <i class="fas fa-user"></i> <span id="guestName">–ü–æ–¥—Ä—É–≥–∞</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="url-section">
            <div class="url-box">
                <input type="text" id="urlInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (VK, Rutube, OK, –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏)">
                <button id="loadUrlBtn"><i class="fas fa-play"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            <div class="supported-sites">
                <span class="vk"><i class="fab fa-vk"></i> VK (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)</span>
                <span class="rutube"><i class="fas fa-play-circle"></i> Rutube (–ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)</span>
                <span class="ok"><i class="fab fa-odnoklassniki"></i> OK</span>
            </div>
        </div>
        
        <div class="main-content">
            <div class="player-container" id="playerContainer">
                <div class="player-header">
                    <h3 id="currentVideoTitle">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ</h3>
                    <div class="sync-indicator" id="syncIndicator">
                        <span class="sync-dot"></span>
                        <span>–°–∏–Ω—Ö—Ä.</span>
                    </div>
                </div>
                <div class="player-wrapper" id="playerWrapper">
                    <iframe id="videoPlayer" frameborder="0" allowfullscreen allow="autoplay; encrypted-media; fullscreen"></iframe>
                    <div class="native-video-player" id="nativePlayer">
                        <video id="nativeVideo" controls></video>
                    </div>
                </div>
                
                <div class="player-controls-overlay">
                    <button class="control-btn" id="syncNowBtn" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å">
                        <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä.
                    </button>
                </div>
                
                <div class="sync-status" id="syncStatus">
                    <i class="fas fa-sync-alt fa-spin"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
                </div>
                <div class="sync-progress" id="syncProgress"></div>
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    <span><i class="fas fa-comment"></i> –ß–∞—Ç</span>
                    <span class="online-count" id="onlineCount">0 –æ–Ω–ª–∞–π–Ω</span>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="typing-indicator" id="typingIndicator" style="display: none;"></div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                    <button class="chat-send-btn" id="sendMessageBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="message-badge" id="messageBadge">
        <i class="fas fa-comment"></i> <span id="badgeText">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAOytQY6UErb0MAJI5WrBCf-jD9nq4XMcE",
            authDomain: "cinemateapp1.firebaseapp.com",
            databaseURL: "https://cinemateapp1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cinemateapp1",
            storageBucket: "cinemateapp1.firebasestorage.app",
            messagingSenderId: "916445746392",
            appId: "1:916445746392:web:4a9afd407a7ea9c60933ad"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ============== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentUser = {
            id: generateUserId(),
            name: generateUserName(),
            isHost: false,
            roomId: null
        };
        
        let roomRef = null;
        let usersRef = null;
        let videoStateRef = null;
        let chatRef = null;
        
        let videoElement = null;
        let isSyncing = false;
        let syncInterval = null;
        let currentVideoData = null;
        
        // –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø
        let syncCheckInterval = null;
        const SYNC_CHECK_INTERVAL = 15000; // 15 —Å–µ–∫—É–Ω–¥
        const SYNC_TOLERANCE = 2; // –¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ 2 —Å–µ–∫—É–Ω–¥—ã
        let roomHostId = null;
        let lastSyncTime = 0;
        let isSyncedWithHost = true; // —Ñ–ª–∞–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å —Ö–æ—Å—Ç–æ–º
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const roomIdInput = document.getElementById('roomIdInput');
        const roomInfo = document.getElementById('roomInfo');
        const currentRoomIdSpan = document.getElementById('currentRoomId');
        const copyRoomIdBtn = document.getElementById('copyRoomIdBtn');
        const hostName = document.getElementById('hostName');
        const guestBadge = document.getElementById('guestBadge');
        const guestName = document.getElementById('guestName');
        const onlineCount = document.getElementById('onlineCount');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const urlInput = document.getElementById('urlInput');
        const videoPlayer = document.getElementById('videoPlayer');
        const nativePlayer = document.getElementById('nativePlayer');
        const nativeVideo = document.getElementById('nativeVideo');
        const currentVideoTitle = document.getElementById('currentVideoTitle');
        const syncNowBtn = document.getElementById('syncNowBtn');
        const syncStatus = document.getElementById('syncStatus');
        const syncProgress = document.getElementById('syncProgress');
        const syncIndicator = document.getElementById('syncIndicator');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const messageBadge = document.getElementById('messageBadge');
        const nickDisplay = document.getElementById('nickDisplay');
        const nickInput = document.getElementById('nickInput');
        const nickEditBtn = document.getElementById('nickEditBtn');
        const nickSaveBtn = document.getElementById('nickSaveBtn');
        const nickCancelBtn = document.getElementById('nickCancelBtn');

        // ==================== –§–£–ù–ö–¶–ò–ò –°–ú–ï–ù–´ –ù–ò–ö–ê ====================
        function initNickControls() {
            nickDisplay.textContent = currentUser.name;
            
            nickEditBtn.addEventListener('click', () => {
                nickDisplay.style.display = 'none';
                nickInput.style.display = 'block';
                nickSaveBtn.style.display = 'block';
                nickCancelBtn.style.display = 'block';
                nickEditBtn.style.display = 'none';
                nickInput.value = currentUser.name;
                nickInput.focus();
            });

            nickSaveBtn.addEventListener('click', saveNick);
            nickCancelBtn.addEventListener('click', cancelEditNick);
            nickInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveNick();
                if (e.key === 'Escape') cancelEditNick();
            });
        }

        function saveNick() {
            const newNick = nickInput.value.trim();
            if (!newNick) {
                alert('–ù–∏–∫ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
                return;
            }

            if (newNick.length > 20) {
                alert('–ù–∏–∫ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 20 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            currentUser.name = newNick;
            nickDisplay.textContent = newNick;

            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∏–∫ –≤ –∫–æ–º–Ω–∞—Ç–µ, –µ—Å–ª–∏ –º—ã –≤ –Ω–µ–π
            if (currentUser.roomId && usersRef) {
                usersRef.child(currentUser.id).update({ name: newNick });
                addChatMessage('–°–∏—Å—Ç–µ–º–∞', `‚úèÔ∏è ${nickDisplay.textContent} –∏–∑–º–µ–Ω–∏–ª –Ω–∏–∫`, 'system');
            }

            cancelEditNick();
        }

        function cancelEditNick() {
            nickDisplay.style.display = 'block';
            nickInput.style.display = 'none';
            nickSaveBtn.style.display = 'none';
            nickCancelBtn.style.display = 'none';
            nickEditBtn.style.display = 'block';
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –û –°–û–û–ë–©–ï–ù–ò–Ø–• ====================
        function showMessageBadge(senderName) {
            const badgeText = document.getElementById('badgeText');
            badgeText.textContent = `–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${senderName}`;
            
            messageBadge.classList.remove('hide');
            messageBadge.classList.add('show');
            
            // –ó–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            playNotificationSound();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                messageBadge.classList.add('hide');
                setTimeout(() => {
                    messageBadge.classList.remove('show');
                }, 300);
            }, 4000);
        }

        function playNotificationSound() {
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–≤—É–∫ —á–µ—Ä–µ–∑ Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800; // –í—ã—Å–æ—Ç–∞ –∑–≤—É–∫–∞
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', e);
            }
        }

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateUserName() {
            const names = ['–ö–∏–Ω–æ–º–∞–Ω', 'MovieFan', 'Cinephile', '–ó—Ä–∏—Ç–µ–ª—å', '–°–µ—Ä–∏–∞–ª–æ–º–∞–Ω'];
            return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 1000);
        }

        function showSyncStatus(show = true, autoHide = true) {
            syncStatus.style.display = show ? 'flex' : 'none';
            if (show && autoHide) {
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 2000);
            }
        }

        function updateSyncProgress(percent) {
            syncProgress.style.width = percent + '%';
        }

        function updateSyncIndicator(synced) {
            isSyncedWithHost = synced;
            if (synced) {
                syncIndicator.classList.add('synced');
                syncIndicator.innerHTML = '<span class="sync-dot"></span><span>–°–∏–Ω—Ö—Ä.</span>';
            } else {
                syncIndicator.classList.remove('synced');
                syncIndicator.innerHTML = '<span class="sync-dot"></span><span>–û—Ç—Å—Ç–∞—é...</span>';
            }
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                statusIndicator.className = 'status-indicator status-connected';
                statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            }
        }

        // ==================== –§–£–ù–ö–¶–ò–ò –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò –í–ò–î–ï–û ====================
        function applyVideoCommand(videoData) {
            if (!videoElement) return;
            
            console.log(`üé¨ –ü—Ä–∏–º–µ–Ω—è—é –∫–æ–º–∞–Ω–¥—É: ${videoData.command || 'sync'}, –≤—Ä–µ–º—è: ${videoData.currentTime}`);
            
            const currentTime = videoElement.currentTime;
            const timeDiff = Math.abs(currentTime - videoData.currentTime);
            
            // –ü–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ–º –µ—Å–ª–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ > 1 —Å–µ–∫—É–Ω–¥—ã
            if (videoData.currentTime !== undefined && timeDiff > 1) {
                videoElement.currentTime = videoData.currentTime;
            }
            
            // –ú–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            if (videoData.command === 'play' || (videoData.isPlaying && videoElement.paused)) {
                videoElement.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
            } else if (videoData.command === 'pause' || (!videoData.isPlaying && !videoElement.paused)) {
                videoElement.pause();
            }
            
            updateSyncIndicator(true);
            showSyncStatus(true, true);
        }

        function syncVideoState(videoData) {
            if (!videoElement || !videoData) return;
            
            // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–∏ –∫–æ–º–∞–Ω–¥—ã!
            if (videoData.updatedBy === currentUser.id) {
                console.log('üîÑ –ò–≥–Ω–æ—Ä–∏—Ä—É—é —Å–≤–æ—é –∫–æ–º–∞–Ω–¥—É (–æ–Ω–∞ –æ—Ç –º–µ–Ω—è)');
                return;
            }
            
            // –¢–æ–ª—å–∫–æ –Ω–µ-—Ö–æ—Å—Ç –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã –æ—Ç —Ö–æ—Å—Ç–∞
            if (!currentUser.isHost && videoData.updatedBy === roomHostId) {
                console.log(`üé¨ –ì–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É –æ—Ç —Ö–æ—Å—Ç–∞`);
                applyVideoCommand(videoData);
                updateSyncIndicator(true);
            }
            // –•–æ—Å—Ç –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –≥–æ—Å—Ç–µ–π (–æ–Ω –≥–ª–∞–≤–Ω—ã–π)
            else if (currentUser.isHost) {
                console.log('üëë –Ø —Ö–æ—Å—Ç, –∏–≥–Ω–æ—Ä–∏—Ä—É—é –∫–æ–º–∞–Ω–¥—ã –≥–æ—Å—Ç–µ–π');
            }
        }

        function setupNativeVideoListeners() {
            if (!videoElement) return;

            let seekTimeout;

            // –ü–∞—É–∑–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ö–û–ú–ê–ù–î–£ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã —Ö–æ—Å—Ç!)
            videoElement.addEventListener('pause', () => {
                if (!currentUser.roomId || !videoStateRef || !currentUser.isHost) return;
                
                console.log('‚è∏Ô∏è –û—Ç–ø—Ä–∞–≤–ª—è—é –∫–æ–º–∞–Ω–¥—É pause –≤ Firebase (–æ—Ç —Ö–æ—Å—Ç–∞)');
                lastSyncTime = Date.now();
                videoStateRef.update({
                    command: 'pause',
                    isPlaying: false,
                    currentTime: videoElement.currentTime,
                    updatedBy: currentUser.id,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            });

            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ö–û–ú–ê–ù–î–£ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã —Ö–æ—Å—Ç!)
            videoElement.addEventListener('play', () => {
                if (!currentUser.roomId || !videoStateRef || !currentUser.isHost) return;
                
                console.log('‚ñ∂Ô∏è –û—Ç–ø—Ä–∞–≤–ª—è—é –∫–æ–º–∞–Ω–¥—É play –≤ Firebase (–æ—Ç —Ö–æ—Å—Ç–∞)');
                lastSyncTime = Date.now();
                videoStateRef.update({
                    command: 'play',
                    isPlaying: true,
                    currentTime: videoElement.currentTime,
                    updatedBy: currentUser.id,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            });

            // –ü–µ—Ä–µ–º–æ—Ç–∫–∞ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ö–û–ú–ê–ù–î–£ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã —Ö–æ—Å—Ç!)
            videoElement.addEventListener('seeked', () => {
                if (!currentUser.roomId || !videoStateRef || !currentUser.isHost) return;
                
                clearTimeout(seekTimeout);
                seekTimeout = setTimeout(() => {
                    console.log(`‚è™ –û—Ç–ø—Ä–∞–≤–ª—è—é –∫–æ–º–∞–Ω–¥—É seek –Ω–∞ ${videoElement.currentTime}—Å –≤ Firebase (–æ—Ç —Ö–æ—Å—Ç–∞)`);
                    lastSyncTime = Date.now();
                    videoStateRef.update({
                        command: 'seek',
                        currentTime: videoElement.currentTime,
                        updatedBy: currentUser.id,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }, 300);
            });

            // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
            videoElement.addEventListener('timeupdate', () => {
                if (!videoElement) return;
                const percent = (videoElement.currentTime / videoElement.duration) * 100;
                updateSyncProgress(percent);
            });

            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≥–æ—Å—Ç—è - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é)
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(() => {
                if (videoElement && currentUser.roomId && videoStateRef && !currentUser.isHost) {
                    // –ì–æ—Å—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    videoStateRef.update({
                        guestTime: videoElement.currentTime,
                        guestPlaying: !videoElement.paused
                    });
                }
            }, 2000);
        }

        // ==================== –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò ====================
        function startPeriodicSyncCheck() {
            if (syncCheckInterval) clearInterval(syncCheckInterval);
            
            syncCheckInterval = setInterval(() => {
                if (!currentUser.roomId || !videoElement || !videoStateRef || currentUser.isHost) return;
                
                // –¢–æ–ª—å–∫–æ –≥–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                videoStateRef.once('value').then((snapshot) => {
                    const hostVideoData = snapshot.val();
                    if (!hostVideoData) return;
                    
                    const currentTime = videoElement.currentTime;
                    const timeDiff = Math.abs(currentTime - (hostVideoData.currentTime || 0));
                    
                    if (timeDiff > SYNC_TOLERANCE) {
                        console.log(`‚ùó –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ ${timeDiff.toFixed(1)}—Å > ${SYNC_TOLERANCE}—Å`);
                        updateSyncIndicator(false);
                        
                        // –ü–ª–∞–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                        videoElement.currentTime = hostVideoData.currentTime;
                        if (hostVideoData.isPlaying && videoElement.paused) {
                            videoElement.play().catch(e => console.log('–û—à–∏–±–∫–∞:', e));
                        }
                    } else {
                        updateSyncIndicator(true);
                    }
                });
            }, SYNC_CHECK_INTERVAL);
        }

        // ==================== –ü–ê–†–°–ò–ù–ì –í–ò–î–ï–û ====================
        function parseVideoUrl(url) {
            try {
                let normalizedUrl = url
                    .replace('vk.ru', 'vk.com')
                    .replace('vkvideo.ru', 'vk.com');
                
                const urlObj = new URL(normalizedUrl);
                
                // VK
                if (urlObj.hostname.includes('vk.com')) {
                    let match = urlObj.pathname.match(/\/video(-?\d+)_(\d+)/);
                    if (!match) {
                        const zParam = urlObj.searchParams.get('z');
                        if (zParam) match = zParam.match(/video(-?\d+)_(\d+)/);
                    }
                    if (!match) {
                        const wParam = urlObj.searchParams.get('w');
                        if (wParam) match = wParam.match(/video(-?\d+)_(\d+)/);
                    }
                    if (!match) {
                        const videoParam = urlObj.searchParams.get('video');
                        if (videoParam) match = videoParam.match(/(-?\d+)_(\d+)/);
                    }
                    if (match) {
                        return {
                            type: 'vk',
                            embedUrl: `https://vk.com/video_ext.php?oid=${match[1]}&id=${match[2]}&autoplay=1`,
                            title: 'VK –í–∏–¥–µ–æ',
                            videoId: `${match[1]}_${match[2]}`,
                            apiAvailable: true
                        };
                    }
                }
                
                // Rutube
                if (urlObj.hostname.includes('rutube.ru')) {
                    const match = urlObj.pathname.match(/\/video\/([a-zA-Z0-9]+)/);
                    if (match) {
                        return {
                            type: 'rutube',
                            embedUrl: `https://rutube.ru/play/embed/${match[1]}/`,
                            title: 'Rutube –í–∏–¥–µ–æ',
                            videoId: match[1],
                            apiAvailable: true
                        };
                    }
                }
                
                // OK.ru
                if (urlObj.hostname.includes('ok.ru') || urlObj.hostname.includes('odnoklassniki.ru')) {
                    const match = urlObj.pathname.match(/\/video\/(\d+)/);
                    if (match) {
                        return {
                            type: 'ok',
                            embedUrl: `https://ok.ru/videoembed/${match[1]}`,
                            title: 'OK –í–∏–¥–µ–æ',
                            videoId: match[1],
                            apiAvailable: false
                        };
                    }
                }
                
                // –ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏
                if (url.match(/\.(mp4|webm|ogg|mov|avi)$/i)) {
                    return {
                        type: 'direct',
                        embedUrl: url,
                        title: '–ü—Ä—è–º–æ–µ –≤–∏–¥–µ–æ',
                        isDirect: true,
                        apiAvailable: true
                    };
                }
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ URL:', e);
            }
            return null;
        }

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û ====================
        function loadVideo(url, title = '') {
            const videoData = parseVideoUrl(url);
            if (!videoData) {
                alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è —Å—Å—ã–ª–∫–∞');
                return false;
            }

            currentVideoData = videoData;

            if (videoElement) {
                videoElement.pause();
                videoElement.src = '';
            }

            if (videoData.type === 'direct') {
                videoPlayer.style.display = 'none';
                nativePlayer.style.display = 'block';
                nativeVideo.src = videoData.embedUrl;
                nativeVideo.load();
                videoElement = nativeVideo;
                setupNativeVideoListeners();
                
            } else {
                nativePlayer.style.display = 'none';
                videoPlayer.style.display = 'block';
                videoPlayer.src = videoData.embedUrl;
                videoElement = null;
            }

            currentVideoTitle.textContent = title || videoData.title || '–í–∏–¥–µ–æ';

            if (currentUser.roomId && videoStateRef) {
                videoStateRef.update({
                    url: url,
                    embedUrl: videoData.embedUrl,
                    title: currentVideoTitle.textContent,
                    type: videoData.type,
                    isDirect: videoData.isDirect || false,
                    isPlaying: false,
                    currentTime: 0,
                    updatedBy: currentUser.id,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                });
            }

            addChatMessage('–°–∏—Å—Ç–µ–º–∞', `üé¨ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${currentVideoTitle.textContent}`, 'system');
            return true;
        }

        // ==================== FIREBASE –ö–û–ú–ù–ê–¢–´ ====================
        function createRoom() {
            const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
            
            if (roomRef) roomRef.off();
            if (syncInterval) clearInterval(syncInterval);
            
            roomRef = database.ref(`rooms/${roomId}`);
            usersRef = database.ref(`rooms/${roomId}/users`);
            videoStateRef = database.ref(`rooms/${roomId}/video`);
            chatRef = database.ref(`rooms/${roomId}/messages`);
            
            roomRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                hostId: currentUser.id,
                users: {
                    [currentUser.id]: {
                        name: currentUser.name,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        isHost: true
                    }
                },
                video: {
                    url: '',
                    embedUrl: '',
                    title: '',
                    isPlaying: false,
                    currentTime: 0,
                    updatedBy: currentUser.id,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                }
            }).then(() => {
                currentUser.roomId = roomId;
                currentUser.isHost = true;
                roomHostId = currentUser.id;
                
                joinRoomSuccess(roomId);
                setupRoomListeners(roomId);
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã');
            });
        }

        function joinRoom(roomId) {
            roomRef = database.ref(`rooms/${roomId}`);
            usersRef = database.ref(`rooms/${roomId}/users`);
            videoStateRef = database.ref(`rooms/${roomId}/video`);
            chatRef = database.ref(`rooms/${roomId}/messages`);
            
            roomRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    roomHostId = snapshot.val().hostId;
                    
                    usersRef.child(currentUser.id).set({
                        name: currentUser.name,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        isHost: false
                    }).then(() => {
                        currentUser.roomId = roomId;
                        currentUser.isHost = false;
                        
                        joinRoomSuccess(roomId);
                        setupRoomListeners(roomId);
                    });
                } else {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            });
        }

        function joinRoomSuccess(roomId) {
            currentRoomIdSpan.textContent = roomId;
            roomInfo.style.display = 'flex';
            
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            roomIdInput.disabled = true;
            leaveRoomBtn.style.display = 'inline-block';
            chatInput.disabled = false;
            sendMessageBtn.disabled = false;
            
            roomIdInput.value = '';
            
            addChatMessage('–°–∏—Å—Ç–µ–º–∞', currentUser.isHost ? 
                'üëë –í—ã —Å–æ–∑–¥–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—É (–≤—ã —Ö–æ—Å—Ç)' : 
                '‚úÖ –í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ', 'system');
            
            if (!currentUser.isHost) {
                startPeriodicSyncCheck();
            }
        }

        function leaveRoom() {
            if (!currentUser.roomId) return;
            
            if (syncCheckInterval) {
                clearInterval(syncCheckInterval);
                syncCheckInterval = null;
            }
            
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            
            if (usersRef) {
                usersRef.child(currentUser.id).remove();
            }
            
            if (currentUser.isHost && roomRef) {
                roomRef.remove();
            }
            
            if (roomRef) roomRef.off();
            if (usersRef) usersRef.off();
            if (videoStateRef) videoStateRef.off();
            if (chatRef) chatRef.off();
            
            currentUser.roomId = null;
            currentUser.isHost = false;
            currentVideoData = null;
            roomHostId = null;
            
            createRoomBtn.disabled = false;
            joinRoomBtn.disabled = false;
            roomIdInput.disabled = false;
            leaveRoomBtn.style.display = 'none';
            roomInfo.style.display = 'none';
            chatInput.disabled = true;
            sendMessageBtn.disabled = true;
            
            videoPlayer.src = '';
            nativeVideo.src = '';
            nativePlayer.style.display = 'none';
            videoPlayer.style.display = 'block';
            currentVideoTitle.textContent = '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ';
            updateSyncProgress(0);
            updateSyncIndicator(true);
            
            addChatMessage('–°–∏—Å—Ç–µ–º–∞', 'üëã –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É', 'system');
        }

        // ==================== –°–õ–£–®–ê–¢–ï–õ–ò –ö–û–ú–ù–ê–¢–´ ====================
        function setupRoomListeners(roomId) {
            console.log('üì° –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–ª—É—à–∞—Ç–µ–ª–∏ –∫–æ–º–Ω–∞—Ç—ã');
            
            usersRef.on('value', (snapshot) => {
                const users = snapshot.val() || {};
                const userCount = Object.keys(users).length;
                onlineCount.textContent = `${userCount} –æ–Ω–ª–∞–π–Ω`;
                
                let hostFound = false;
                guestBadge.style.display = 'none';
                
                Object.entries(users).forEach(([id, user]) => {
                    if (user.isHost) {
                        hostName.textContent = user.name;
                        roomHostId = id;
                        hostFound = true;
                    } else {
                        guestName.textContent = user.name;
                        guestBadge.style.display = 'flex';
                    }
                });
                
                if (!hostFound && currentUser.roomId) {
                    alert('–•–æ—Å—Ç –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É');
                    leaveRoom();
                }
            });

            videoStateRef.on('value', (snapshot) => {
                const videoData = snapshot.val();
                if (!videoData) return;
                
                console.log('üì° –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ:', videoData);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                if (videoData.url && (!currentVideoTitle.textContent || currentVideoTitle.textContent === '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ')) {
                    loadVideo(videoData.url, videoData.title);
                    return;
                }
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                syncVideoState(videoData);
            });

            chatRef.limitToLast(50).on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message && message.userId !== currentUser.id) {
                    displayMessage(message);
                    showMessageBadge(message.userName);
                }
            });
        }

        // ==================== –ß–ê–¢ ====================
        function sendMessage(text) {
            if (!currentUser.roomId || !text.trim()) return;
            
            const message = {
                userId: currentUser.id,
                userName: currentUser.name,
                text: text.trim(),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            chatRef.push(message).then(() => {
                displayMessage(message, true);
            });
            
            database.ref(`rooms/${currentUser.roomId}/typing`).remove();
        }

        function displayMessage(message, isOwn = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : (message.userId === 'system' ? 'system' : 'other')}`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (message.userId === 'system') {
                messageDiv.innerHTML = `
                    <div class="text">${message.text}</div>
                    <div class="time">${time}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="sender">${isOwn ? '–í—ã' : message.userName}</div>
                    <div class="text">${message.text}</div>
                    <div class="time">${time}</div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addChatMessage(sender, text, type = 'system') {
            displayMessage({
                userId: 'system',
                userName: sender,
                text: text
            });
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        updateConnectionStatus(true);
        initNickControls();

        database.ref('.info/connected').on('value', (snapshot) => {
            updateConnectionStatus(snapshot.val() === true);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        createRoomBtn.addEventListener('click', createRoom);
        
        joinRoomBtn.addEventListener('click', () => {
            const roomId = roomIdInput.value.trim().toUpperCase();
            if (roomId) {
                joinRoom(roomId);
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
            }
        });
        
        leaveRoomBtn.addEventListener('click', leaveRoom);
        
        copyRoomIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(currentRoomIdSpan.textContent).then(() => {
                alert('ID –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
            }).catch(() => {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID');
            });
        });

        loadUrlBtn.addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (url) {
                if (!currentUser.roomId) {
                    alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É');
                    return;
                }
                if (!currentUser.isHost) {
                    alert('–¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤–∏–¥–µ–æ');
                    return;
                }
                loadVideo(url);
                urlInput.value = '';
            }
        });

        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadUrlBtn.click();
        });

        syncNowBtn.addEventListener('click', () => {
            if (currentUser.roomId && videoStateRef && currentVideoData && currentUser.isHost) {
                if (currentVideoData.type === 'direct' && videoElement) {
                    videoStateRef.update({
                        command: 'seek',
                        currentTime: videoElement.currentTime,
                        isPlaying: !videoElement.paused,
                        updatedBy: currentUser.id,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                showSyncStatus(true);
            }
        });

        // –ß–∞—Ç
        sendMessageBtn.addEventListener('click', () => {
            sendMessage(chatInput.value);
            chatInput.value = '';
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(chatInput.value);
                chatInput.value = '';
            }
            
            if (currentUser.roomId) {
                database.ref(`rooms/${currentUser.roomId}/typing`).set({
                    userId: currentUser.id,
                    userName: currentUser.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                clearTimeout(window.typingTimeout);
                window.typingTimeout = setTimeout(() => {
                    database.ref(`rooms/${currentUser.roomId}/typing`).remove();
                }, 2000);
            }
        });

        // –ö–ª–∏–∫ –Ω–∞ –±–µ–π–¥–∂ —Å–∫—Ä—ã–≤–∞–µ—Ç –µ–≥–æ
        messageBadge.addEventListener('click', () => {
            messageBadge.classList.add('hide');
            setTimeout(() => {
                messageBadge.classList.remove('show');
            }, 300);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        window.addEventListener('beforeunload', () => {
            if (currentUser.roomId) {
                leaveRoom();
            }
        });

        addChatMessage('–°–∏—Å—Ç–µ–º–∞', 'üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'system');
    </script>
</body>
</html>
