<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>CINEMATE ¬∑ –ò–¥–µ–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</title>
    <style>
        /* –°—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0b0e14; 
            color: white; 
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 16px; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 600;
        }
        
        .logo i {
            color: #5f7cff;
            margin-right: 8px;
        }
        
        .connection-status {
            background: #1a1f2b;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            border: 1px solid #333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #4caf50; box-shadow: 0 0 10px #4caf50; }
        .status-disconnected { background: #ff6b6b; }
        .status-connecting { background: #ffaa00; }
        
        .guide {
            background: #1a1f2b;
            border-radius: 16px;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-left: 4px solid #5f7cff;
        }
        
        .guide h4 {
            color: #5f7cff;
            margin-bottom: 10px;
        }
        
        .guide ol {
            margin-left: 20px;
            color: #aaa;
            line-height: 1.6;
        }
        
        .room-section {
            background: #1a1f2b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .room-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #5f7cff;
        }
        
        .room-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .room-btn {
            background: #5f7cff;
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 14px;
        }
        
        .room-btn.secondary {
            background: #2a2f3a;
        }
        
        .room-btn.danger {
            background: #ff6b6b;
        }
        
        .room-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        
        .room-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .room-input {
            background: #0b0e14;
            border: 1px solid #333;
            color: white;
            padding: 12px 15px;
            border-radius: 50px;
            width: 250px;
            outline: none;
        }
        
        .room-input:focus {
            border-color: #5f7cff;
        }
        
        .room-info {
            margin-top: 15px;
            padding: 15px;
            background: #0b0e14;
            border-radius: 12px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .room-id-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1a1f2b;
            padding: 8px 16px;
            border-radius: 50px;
        }
        
        .room-id {
            font-family: monospace;
            font-size: 18px;
            color: #5f7cff;
            font-weight: 600;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
        }
        
        .copy-btn:hover {
            color: #5f7cff;
        }
        
        .users-list {
            display: flex;
            gap: 10px;
        }
        
        .user-badge {
            background: #2a2f3a;
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-badge.host {
            background: #5f7cff;
        }
        
        .user-badge i {
            font-size: 12px;
        }
        
        .url-section {
            margin-bottom: 20px;
        }
        
        .url-box {
            display: flex;
            gap: 10px;
            background: #1a1f2b;
            border-radius: 50px;
            padding: 5px;
            border: 1px solid #333;
        }
        
        .url-box input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 15px 20px;
            color: white;
            font-size: 16px;
            outline: none;
        }
        
        .url-box button {
            background: #5f7cff;
            border: none;
            border-radius: 50px;
            padding: 0 30px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            white-space: nowrap;
        }
        
        .url-box button:hover {
            background: #738dff;
        }
        
        .supported-sites {
            display: flex;
            gap: 15px;
            margin: 10px 0 0 15px;
            color: #888;
            font-size: 13px;
            flex-wrap: wrap;
        }
        
        .supported-sites span i {
            margin-right: 5px;
        }
        
        .supported-sites .vk { color: #4a76a8; }
        .supported-sites .rutube { color: #7cd3ff; }
        .supported-sites .ok { color: #ee8208; }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 20px;
            height: calc(100vh - 300px);
            min-height: 500px;
        }
        
        .player-container {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
        }
        
        .player-header {
            padding: 16px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-header h3 {
            font-size: 16px;
            max-width: 70%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }
        
        .player-wrapper {
            flex: 1;
            background: #000;
            position: relative;
        }
        
        #videoPlayer {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .native-video-player {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .native-video-player video {
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        .player-controls-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            z-index: 20;
            pointer-events: none;
            flex-wrap: wrap;
        }
        
        .player-controls-overlay button {
            pointer-events: auto;
        }
        
        .control-btn {
            background: rgba(95, 124, 255, 0.9);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        
        .control-btn:hover {
            background: #5f7cff;
            transform: scale(1.05);
        }
        
        .control-btn.secondary {
            background: rgba(42, 47, 58, 0.9);
        }
        
        .sync-status {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 13px;
            z-index: 30;
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        .chat-container {
            background: #1a1f2b;
            border-radius: 16px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            font-weight: 600;
            color: #5f7cff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .online-count {
            background: #2a2f3a;
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 12px;
            color: #aaa;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.own {
            background: #5f7cff;
            align-self: flex-end;
        }
        
        .message.other {
            background: #2a2f3a;
            align-self: flex-start;
        }
        
        .message.system {
            background: #333;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-style: italic;
            opacity: 0.8;
            font-size: 12px;
        }
        
        .message .sender {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        .message .text {
            font-size: 14px;
            line-height: 1.4;
        }
        
        .message .time {
            font-size: 10px;
            opacity: 0.5;
            text-align: right;
            margin-top: 4px;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: #0b0e14;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            border-radius: 25px;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #5f7cff;
        }
        
        .chat-send-btn {
            background: #5f7cff;
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .chat-send-btn:hover:not(:disabled) {
            background: #738dff;
            transform: scale(1.1);
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            color: #888;
            font-size: 12px;
            padding: 5px 15px;
            font-style: italic;
        }
        
        .sync-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #5f7cff;
            width: 0%;
            transition: width 0.3s;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .player-container {
                height: 50vh;
            }
            
            .chat-container {
                height: 400px;
            }
        }
        
        @media (max-width: 600px) {
            .url-box {
                flex-direction: column;
                border-radius: 24px;
            }
            
            .url-box button {
                padding: 12px;
                margin: 0 5px 5px 5px;
            }
            
            .room-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .room-input {
                width: 100%;
            }
            
            .room-info {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-film"></i> CINEMATE
            </div>
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                <span id="statusText">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É</span>
            </div>
        </div>
        
        <div class="guide">
            <h4><i class="fas fa-info-circle"></i> –ö–∞–∫ —Å–º–æ—Ç—Ä–µ—Ç—å –≤–º–µ—Å—Ç–µ:</h4>
            <ol>
                <li><strong>–°–æ–∑–¥–∞—Ç–µ–ª—å</strong> –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É" ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ID –ø–æ–¥—Ä—É–≥–µ</li>
                <li><strong>–°–æ–∑–¥–∞—Ç–µ–ª—å</strong> –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "–ó–∞–≥—Ä—É–∑–∏—Ç—å"</li>
                <li><strong>–ü–æ–¥—Ä—É–≥–∞</strong> –≤–≤–æ–¥–∏—Ç ID –∫–æ–º–Ω–∞—Ç—ã ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"</li>
                <li>–û–±–∞ –º–æ–≥—É—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–∏–¥–µ–æ - –≤—Å—ë —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                <li>–û–±—â–∞–π—Ç–µ—Å—å –≤ —á–∞—Ç–µ –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞!</li>
            </ol>
        </div>
        
        <div class="room-section">
            <div class="room-title">
                <i class="fas fa-users"></i> –ö–æ–º–Ω–∞—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            </div>
            <div class="room-controls">
                <button class="room-btn" id="createRoomBtn">
                    <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                </button>
                <input type="text" class="room-input" id="roomIdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã">
                <button class="room-btn secondary" id="joinRoomBtn">
                    <i class="fas fa-door-open"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                </button>
                <button class="room-btn danger" id="leaveRoomBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> –ü–æ–∫–∏–Ω—É—Ç—å
                </button>
            </div>
            
            <div class="room-info" id="roomInfo" style="display: none;">
                <div class="room-id-box">
                    <i class="fas fa-door-open"></i>
                    <span class="room-id" id="currentRoomId"></span>
                    <button class="copy-btn" id="copyRoomIdBtn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
                <div class="users-list" id="usersList">
                    <div class="user-badge host" id="hostBadge">
                        <i class="fas fa-crown"></i> <span id="hostName">–•–æ—Å—Ç</span>
                    </div>
                    <div class="user-badge" id="guestBadge" style="display: none;">
                        <i class="fas fa-user"></i> <span id="guestName">–ü–æ–¥—Ä—É–≥–∞</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="url-section">
            <div class="url-box">
                <input type="text" id="urlInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (VK, Rutube, OK, –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏)">
                <button id="loadUrlBtn"><i class="fas fa-play"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            </div>
            <div class="supported-sites">
                <span class="vk"><i class="fab fa-vk"></i> VK (–≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã)</span>
                <span class="rutube"><i class="fas fa-play-circle"></i> Rutube (–ø–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)</span>
                <span class="ok"><i class="fab fa-odnoklassniki"></i> OK</span>
            </div>
        </div>
        
        <div class="main-content">
            <div class="player-container" id="playerContainer">
                <div class="player-header">
                    <h3 id="currentVideoTitle">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ</h3>
                </div>
                <div class="player-wrapper" id="playerWrapper">
                    <iframe id="videoPlayer" frameborder="0" allowfullscreen allow="autoplay; encrypted-media; fullscreen"></iframe>
                    <div class="native-video-player" id="nativePlayer">
                        <video id="nativeVideo" controls></video>
                    </div>
                </div>
                
                <div class="player-controls-overlay">
                    <button class="control-btn" id="syncNowBtn" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å">
                        <i class="fas fa-sync-alt"></i> –°–∏–Ω—Ö—Ä.
                    </button>
                </div>
                
                <div class="sync-status" id="syncStatus">
                    <i class="fas fa-sync-alt fa-spin"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...
                </div>
                <div class="sync-progress" id="syncProgress"></div>
            </div>
            
            <div class="chat-container">
                <div class="chat-header">
                    <span><i class="fas fa-comment"></i> –ß–∞—Ç</span>
                    <span class="online-count" id="onlineCount">0 –æ–Ω–ª–∞–π–Ω</span>
                </div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="typing-indicator" id="typingIndicator" style="display: none;"></div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
                    <button class="chat-send-btn" id="sendMessageBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAOytQY6UErb0MAJI5WrBCf-jD9nq4XMcE",
            authDomain: "cinemateapp1.firebaseapp.com",
            databaseURL: "https://cinemateapp1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cinemateapp1",
            storageBucket: "cinemateapp1.firebasestorage.app",
            messagingSenderId: "916445746392",
            appId: "1:916445746392:web:4a9afd407a7ea9c60933ad"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ============== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentUser = {
            id: generateUserId(),
            name: generateUserName(),
            isHost: false,
            roomId: null
        };
        
        let roomRef = null;
        let usersRef = null;
        let videoStateRef = null;
        let chatRef = null;
        
        let videoElement = null;
        let isSyncing = false;
        let ignoreNextEvent = false;
        let syncInterval = null;
        let currentVideoData = null;
        
        // –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–û–ô –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò
        let syncCheckInterval = null;
        const SYNC_CHECK_INTERVAL = 15000; // 15 —Å–µ–∫—É–Ω–¥
        const SYNC_TOLERANCE = 5; // –¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ 5 —Å–µ–∫—É–Ω–¥
        let lastSyncCheck = 0;
        
        // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –ø–ª–µ–µ—Ä–æ–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let rutubePlayer = null;
        let vkPlayer = null;
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const roomIdInput = document.getElementById('roomIdInput');
        const roomInfo = document.getElementById('roomInfo');
        const currentRoomIdSpan = document.getElementById('currentRoomId');
        const copyRoomIdBtn = document.getElementById('copyRoomIdBtn');
        const hostName = document.getElementById('hostName');
        const guestBadge = document.getElementById('guestBadge');
        const guestName = document.getElementById('guestName');
        const onlineCount = document.getElementById('onlineCount');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const urlInput = document.getElementById('urlInput');
        const videoPlayer = document.getElementById('videoPlayer');
        const nativePlayer = document.getElementById('nativePlayer');
        const nativeVideo = document.getElementById('nativeVideo');
        const currentVideoTitle = document.getElementById('currentVideoTitle');
        const syncNowBtn = document.getElementById('syncNowBtn');
        const syncStatus = document.getElementById('syncStatus');
        const syncProgress = document.getElementById('syncProgress');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function generateUserName() {
            const names = ['–ö–∏–Ω–æ–º–∞–Ω', 'MovieFan', 'Cinephile', '–ó—Ä–∏—Ç–µ–ª—å', '–°–µ—Ä–∏–∞–ª–æ–º–∞–Ω'];
            return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 1000);
        }

        function showSyncStatus(show = true, autoHide = true) {
            syncStatus.style.display = show ? 'flex' : 'none';
            if (show && autoHide) {
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 2000);
            }
        }

        function updateSyncProgress(percent) {
            syncProgress.style.width = percent + '%';
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                statusIndicator.className = 'status-indicator status-connected';
                statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É';
            } else {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            }
        }

        // ==================== –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–û–ô –ü–†–û–í–ï–†–ö–ò ====================
        function startPeriodicSyncCheck() {
            if (syncCheckInterval) clearInterval(syncCheckInterval);
            
            syncCheckInterval = setInterval(() => {
                if (!currentUser.roomId || !videoElement || !videoStateRef || currentUser.isHost) return;
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É Firebase
                videoStateRef.once('value').then((snapshot) => {
                    const hostVideoData = snapshot.val();
                    if (!hostVideoData) return;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏ –ª–∏ –º—ã —Å–∞–º–∏ —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    if (hostVideoData.updatedBy === currentUser.id) return;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–æ–º
                    checkAndSyncWithHost(hostVideoData);
                });
            }, SYNC_CHECK_INTERVAL);
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –†–ê–°–•–û–ñ–î–ï–ù–ò–ô
        function checkAndSyncWithHost(hostData) {
            if (!videoElement) return;
            
            const currentTime = videoElement.currentTime;
            const timeDiff = Math.abs(currentTime - hostData.currentTime);
            
            console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: —Ç–µ–∫—É—â–µ–µ ${currentTime.toFixed(1)}—Å, —Ö–æ—Å—Ç ${hostData.currentTime.toFixed(1)}—Å, —Ä–∞–∑–Ω–∏—Ü–∞ ${timeDiff.toFixed(1)}—Å`);
            
            // –ï—Å–ª–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –±–æ–ª—å—à–µ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ (5 —Å–µ–∫—É–Ω–¥)
            if (timeDiff > SYNC_TOLERANCE) {
                console.log(`‚ùó –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ ${timeDiff.toFixed(1)}—Å > ${SYNC_TOLERANCE}—Å, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Å—å`);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showSyncStatus(true, false);
                
                // –ü–ª–∞–≤–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                gentleSync(hostData.currentTime, hostData.isPlaying);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => showSyncStatus(false), 3000);
            } else {
                console.log(`‚úÖ –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ ${timeDiff.toFixed(1)}—Å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã`);
            }
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–õ–ê–í–ù–û–ô –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò
        function gentleSync(targetTime, shouldBePlaying) {
            if (!videoElement) return;
            
            ignoreNextEvent = true;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –∑–∞–±—É—Ñ–µ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ø–µ—Ä–µ–º–æ—Ç–∫–∏
            const buffered = videoElement.buffered;
            let canSeek = false;
            
            for (let i = 0; i < buffered.length; i++) {
                if (targetTime >= buffered.start(i) && targetTime <= buffered.end(i)) {
                    canSeek = true;
                    break;
                }
            }
            
            if (canSeek) {
                // –ï—Å–ª–∏ —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è —É–∂–µ –≤ –±—É—Ñ–µ—Ä–µ - –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
                videoElement.currentTime = targetTime;
            } else {
                // –ï—Å–ª–∏ –Ω–µ –≤ –±—É—Ñ–µ—Ä–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                addChatMessage('–°–∏—Å—Ç–µ–º–∞', '‚è≥ –î–æ–≥–æ–Ω—è—é –ø–æ—Ç–æ–∫...', 'system');
                
                // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–º–æ—Ç–∞—Ç—å –∏ –Ω–∞–¥–µ–µ–º—Å—è, —á—Ç–æ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—Å—è
                videoElement.currentTime = targetTime;
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
            if (shouldBePlaying && videoElement.paused) {
                videoElement.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
            } else if (!shouldBePlaying && !videoElement.paused) {
                videoElement.pause();
            }
            
            setTimeout(() => {
                ignoreNextEvent = false;
            }, 1000);
        }

        // ==================== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ü–ê–†–°–ò–ù–ì –í–ò–î–ï–û ====================
        function parseVideoUrl(url) {
            try {
                // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º URL
                let normalizedUrl = url
                    .replace('vk.ru', 'vk.com')
                    .replace('vkvideo.ru', 'vk.com');
                
                const urlObj = new URL(normalizedUrl);
                
                // 1. VK (–≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã)
                if (urlObj.hostname.includes('vk.com')) {
                    let match = null;
                    
                    // –ü–∞—Ç—Ç–µ—Ä–Ω 1: /video-123456_789012
                    match = urlObj.pathname.match(/\/video(-?\d+)_(\d+)/);
                    
                    // –ü–∞—Ç—Ç–µ—Ä–Ω 2: ?z=video-123456_789012
                    if (!match) {
                        const zParam = urlObj.searchParams.get('z');
                        if (zParam) {
                            const videoMatch = zParam.match(/video(-?\d+)_(\d+)/);
                            if (videoMatch) match = videoMatch;
                        }
                    }
                    
                    // –ü–∞—Ç—Ç–µ—Ä–Ω 3: ?w=wall-123456_789012
                    if (!match) {
                        const wParam = urlObj.searchParams.get('w');
                        if (wParam) {
                            const videoMatch = wParam.match(/video(-?\d+)_(\d+)/);
                            if (videoMatch) match = videoMatch;
                        }
                    }
                    
                    // –ü–∞—Ç—Ç–µ—Ä–Ω 4: /wall-123456_789012?video=123456_789012
                    if (!match) {
                        const videoParam = urlObj.searchParams.get('video');
                        if (videoParam) {
                            const videoMatch = videoParam.match(/(-?\d+)_(\d+)/);
                            if (videoMatch) match = videoMatch;
                        }
                    }
                    
                    if (match) {
                        return {
                            type: 'vk',
                            embedUrl: `https://vk.com/video_ext.php?oid=${match[1]}&id=${match[2]}&autoplay=1`,
                            title: 'VK –í–∏–¥–µ–æ',
                            videoId: `${match[1]}_${match[2]}`,
                            apiAvailable: true
                        };
                    }
                }
                
                // 2. Rutube (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π API)
                if (urlObj.hostname.includes('rutube.ru')) {
                    const match = urlObj.pathname.match(/\/video\/([a-zA-Z0-9]+)/);
                    if (match) {
                        return {
                            type: 'rutube',
                            embedUrl: `https://rutube.ru/play/embed/${match[1]}/`,
                            title: 'Rutube –í–∏–¥–µ–æ',
                            videoId: match[1],
                            apiAvailable: true // Rutube –∏–º–µ–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ API [citation:5]
                        };
                    }
                }
                
                // 3. OK.ru
                if (urlObj.hostname.includes('ok.ru') || urlObj.hostname.includes('odnoklassniki.ru')) {
                    const match = urlObj.pathname.match(/\/video\/(\d+)/);
                    if (match) {
                        return {
                            type: 'ok',
                            embedUrl: `https://ok.ru/videoembed/${match[1]}`,
                            title: 'OK –í–∏–¥–µ–æ',
                            videoId: match[1],
                            apiAvailable: false
                        };
                    }
                }
                
                // 4. –ü—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ
                if (url.match(/\.(mp4|webm|ogg|mov|avi)$/i)) {
                    return {
                        type: 'direct',
                        embedUrl: url,
                        title: '–ü—Ä—è–º–æ–µ –≤–∏–¥–µ–æ',
                        isDirect: true,
                        apiAvailable: true // –ù–∞—Ç–∏–≤–Ω–æ–µ video API [citation:2]
                    };
                }
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ URL:', e);
            }
            return null;
        }

        // ==================== –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û –° –ê–í–¢–û–í–´–ë–û–†–û–ú API ====================
        function loadVideo(url, title = '') {
            const videoData = parseVideoUrl(url);
            if (!videoData) {
                alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è —Å—Å—ã–ª–∫–∞');
                return false;
            }

            currentVideoData = videoData;

            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–ª–µ–µ—Ä—ã
            if (videoElement) {
                videoElement.pause();
                videoElement.src = '';
            }
            if (rutubePlayer) rutubePlayer = null;
            if (vkPlayer) vkPlayer = null;

            // –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø –ø–ª–µ–µ—Ä–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö
            if (videoData.type === 'direct') {
                // –ù–∞—Ç–∏–≤–Ω–æ–µ –≤–∏–¥–µ–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º HTML5 video API [citation:2]
                videoPlayer.style.display = 'none';
                nativePlayer.style.display = 'block';
                nativeVideo.src = videoData.embedUrl;
                nativeVideo.load();
                videoElement = nativeVideo;
                setupNativeVideoListeners();
                
            } else if (videoData.type === 'rutube' && videoData.apiAvailable) {
                // Rutube —Å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–º API [citation:5]
                nativePlayer.style.display = 'none';
                videoPlayer.style.display = 'block';
                videoPlayer.src = videoData.embedUrl;
                videoElement = null;
                setupRutubePlayer(videoData.videoId);
                
            } else if (videoData.type === 'vk') {
                // VK –ø–ª–µ–µ—Ä
                nativePlayer.style.display = 'none';
                videoPlayer.style.display = 'block';
                videoPlayer.src = videoData.embedUrl;
                videoElement = null;
                setupVKPlayer(videoData.videoId);
                
            } else {
                // –û–±—ã—á–Ω—ã–π iframe –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
                nativePlayer.style.display = 'none';
                videoPlayer.style.display = 'block';
                videoPlayer.src = videoData.embedUrl;
                videoElement = null;
            }

            currentVideoTitle.textContent = title || videoData.title || '–í–∏–¥–µ–æ';

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Firebase
            if (currentUser.roomId && videoStateRef) {
                videoStateRef.update({
                    url: url,
                    embedUrl: videoData.embedUrl,
                    title: currentVideoTitle.textContent,
                    type: videoData.type,
                    isDirect: videoData.isDirect || false,
                    videoId: videoData.videoId || null,
                    apiAvailable: videoData.apiAvailable || false,
                    isPlaying: false,
                    currentTime: 0,
                    updatedBy: currentUser.id,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                });
            }

            addChatMessage('–°–∏—Å—Ç–µ–º–∞', `üé¨ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${currentVideoTitle.textContent} (${videoData.type})`, 'system');
            return true;
        }

        // ==================== RUTUBE PLAYER API (–ü–û–õ–ù–û–°–¢–¨–Æ –°–ò–ù–•–†–û–ù–ò–ó–ò–†–£–ï–ú–´–ô) ====================
        function setupRutubePlayer(videoId) {
            console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Rutube –ø–ª–µ–µ—Ä–∞ —Å API');
            
            // Rutube –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ postMessage [citation:5]
            window.addEventListener('message', function rutubeListener(event) {
                try {
                    const message = JSON.parse(event.data);
                    
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –æ—Ç –Ω–∞—Å
                    if (ignoreNextEvent) return;
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Rutube –ø–ª–µ–µ—Ä–∞ [citation:5]
                    switch (message.type) {
                        case 'player:ready':
                            console.log('Rutube –ø–ª–µ–µ—Ä –≥–æ—Ç–æ–≤');
                            // –ü–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –º–æ–∂–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–º–∞–Ω–¥—ã
                            break;
                            
                        case 'player:changeState':
                            // –ò–∑–º–µ–Ω–∏–ª–æ—Å—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è [citation:5]
                            if (message.data.state === 'playing' || message.data.state === 'pause') {
                                const isPlaying = message.data.state === 'playing';
                                
                                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (Rutube –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ —ç—Ç–æ–º —Å–æ–±—ã—Ç–∏–∏,
                                // –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
                                getRutubeCurrentTime().then(time => {
                                    if (currentUser.roomId && videoStateRef) {
                                        videoStateRef.update({
                                            isPlaying: isPlaying,
                                            currentTime: time,
                                            updatedBy: currentUser.id
                                        });
                                    }
                                });
                            }
                            break;
                            
                        case 'player:currentTime':
                            // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ Rutube –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –≤—Ä–µ–º—è –æ—Ç–¥–µ–ª—å–Ω–æ
                            if (currentUser.roomId && videoStateRef) {
                                videoStateRef.update({
                                    currentTime: message.data.time,
                                    updatedBy: currentUser.id
                                });
                            }
                            break;
                    }
                } catch (e) {
                    // –ù–µ JSON —Å–æ–æ–±—â–µ–Ω–∏–µ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ Rutube –ø–ª–µ–µ—Ä–∞
        function getRutubeCurrentTime() {
            return new Promise((resolve) => {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ –ø–ª–µ–µ—Ä—É
                videoPlayer.contentWindow.postMessage(JSON.stringify({
                    type: 'player:getCurrentTime'
                }), '*');
                
                // Rutube –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—Ç–∏—Ç—å player:currentTime
                const timeout = setTimeout(() => resolve(0), 1000);
                
                const handler = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        if (message.type === 'player:currentTime') {
                            window.removeEventListener('message', handler);
                            clearTimeout(timeout);
                            resolve(message.data.time);
                        }
                    } catch (e) {}
                };
                
                window.addEventListener('message', handler);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Rutube –ø–ª–µ–µ—Ä–æ–º
        function controlRutubePlayer(command, value = null) {
            if (!videoPlayer || !videoPlayer.contentWindow) return;
            
            let message = {};
            
            switch (command) {
                case 'play':
                    message = { type: 'player:play' };
                    break;
                case 'pause':
                    message = { type: 'player:pause' };
                    break;
                case 'seek':
                    message = { 
                        type: 'player:setCurrentTime',
                        data: { time: value }
                    };
                    break;
            }
            
            videoPlayer.contentWindow.postMessage(JSON.stringify(message), '*');
        }

        // ==================== VK PLAYER ====================
        function setupVKPlayer(videoId) {
            console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ VK –ø–ª–µ–µ—Ä–∞');
            // VK API —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –Ω–æ –≤ iframe –≤–µ—Ä—Å–∏–∏
            // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        }

        // ==================== –ù–ê–¢–ò–í–ù–´–ô –í–ò–î–ï–û –ü–õ–ï–ï–† ====================
        function setupNativeVideoListeners() {
            if (!videoElement) return;

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º HTMLMediaElement API [citation:2]
            videoElement.addEventListener('pause', () => {
                if (ignoreNextEvent || !currentUser.roomId || !videoStateRef) return;
                videoStateRef.update({
                    isPlaying: false,
                    currentTime: videoElement.currentTime,
                    updatedBy: currentUser.id
                });
            });

            videoElement.addEventListener('play', () => {
                if (ignoreNextEvent || !currentUser.roomId || !videoStateRef) return;
                videoStateRef.update({
                    isPlaying: true,
                    currentTime: videoElement.currentTime,
                    updatedBy: currentUser.id
                });
            });

            videoElement.addEventListener('seeked', () => {
                if (ignoreNextEvent || !currentUser.roomId || !videoStateRef) return;
                videoStateRef.update({
                    currentTime: videoElement.currentTime,
                    updatedBy: currentUser.id
                });
            });

            videoElement.addEventListener('timeupdate', () => {
                if (!videoElement) return;
                const percent = (videoElement.currentTime / videoElement.duration) * 100;
                updateSyncProgress(percent);
            });

            // –ò–ó–ú–ï–ù–ï–ù–ù–´–ô –ò–ù–¢–ï–†–í–ê–õ: –•–æ—Å—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è —Ä–∞–∑ –≤ 5 —Å–µ–∫—É–Ω–¥
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(() => {
                // –¢–æ–ª—å–∫–æ —Ö–æ—Å—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ Firebase
                if (videoElement && currentUser.isHost && currentUser.roomId && videoStateRef) {
                    videoStateRef.update({
                        currentTime: videoElement.currentTime,
                        isPlaying: !videoElement.paused,
                        updatedBy: currentUser.id,
                        lastUpdate: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                // –í—Å–µ –æ–±–Ω–æ–≤–ª—è—é—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
                if (videoElement) {
                    const percent = (videoElement.currentTime / videoElement.duration) * 100;
                    updateSyncProgress(percent);
                }
            }, 5000); // –•–æ—Å—Ç –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Ä–µ–º—è —Ä–∞–∑ –≤ 5 —Å–µ–∫—É–Ω–¥, –∞ –Ω–µ –∫–∞–∂–¥—ã–µ 2
        }

        // ==================== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ====================
        function syncVideoState(videoData) {
            if (!videoData || videoData.updatedBy === currentUser.id) return;
            
            // –ò–ó–ú–ï–ù–ï–ù–û: –•–æ—Å—Ç –±–æ–ª—å—à–µ –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –¥—Ä—É–≥–∏–º–∏
            if (currentUser.isHost) {
                return; // –•–æ—Å—Ç –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —á—É–∂–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            }
            
            // –î–ª—è –Ω–µ-—Ö–æ—Å—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å, –Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –≤ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ
            showSyncStatus(true, true);
        }

        // ==================== FIREBASE –ö–û–ú–ù–ê–¢–´ ====================
        function createRoom() {
            const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
            
            if (roomRef) roomRef.off();
            if (syncInterval) clearInterval(syncInterval);
            
            roomRef = database.ref(`rooms/${roomId}`);
            usersRef = database.ref(`rooms/${roomId}/users`);
            videoStateRef = database.ref(`rooms/${roomId}/video`);
            chatRef = database.ref(`rooms/${roomId}/messages`);
            
            roomRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                hostId: currentUser.id,
                users: {
                    [currentUser.id]: {
                        name: currentUser.name,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        isHost: true
                    }
                },
                video: {
                    url: '',
                    embedUrl: '',
                    title: '',
                    isPlaying: false,
                    currentTime: 0
                }
            }).then(() => {
                currentUser.roomId = roomId;
                currentUser.isHost = true;
                
                joinRoomSuccess(roomId);
                setupRoomListeners(roomId);
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã');
            });
        }

        function joinRoom(roomId) {
            roomRef = database.ref(`rooms/${roomId}`);
            usersRef = database.ref(`rooms/${roomId}/users`);
            videoStateRef = database.ref(`rooms/${roomId}/video`);
            chatRef = database.ref(`rooms/${roomId}/messages`);
            
            roomRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    usersRef.child(currentUser.id).set({
                        name: currentUser.name,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        isHost: false
                    }).then(() => {
                        currentUser.roomId = roomId;
                        currentUser.isHost = false;
                        
                        joinRoomSuccess(roomId);
                        setupRoomListeners(roomId);
                    });
                } else {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            });
        }

        // –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –¥–æ–±–∞–≤–ª–µ–Ω –∑–∞–ø—É—Å–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –Ω–µ-—Ö–æ—Å—Ç–∞
        function joinRoomSuccess(roomId) {
            currentRoomIdSpan.textContent = roomId;
            roomInfo.style.display = 'flex';
            
            createRoomBtn.disabled = true;
            joinRoomBtn.disabled = true;
            roomIdInput.disabled = true;
            leaveRoomBtn.style.display = 'inline-block';
            chatInput.disabled = false;
            sendMessageBtn.disabled = false;
            
            roomIdInput.value = '';
            
            addChatMessage('–°–∏—Å—Ç–µ–º–∞', currentUser.isHost ? 
                '‚úÖ –í—ã —Å–æ–∑–¥–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—É (–≤—ã —Ö–æ—Å—Ç)' : 
                '‚úÖ –í—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ', 'system');
            
            // –ó–ê–ü–£–°–ö–ê–ï–ú –ü–ï–†–ò–û–î–ò–ß–ï–°–ö–£–Æ –ü–†–û–í–ï–†–ö–£ (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-—Ö–æ—Å—Ç–∞)
            if (!currentUser.isHost) {
                startPeriodicSyncCheck();
                addChatMessage('–°–∏—Å—Ç–µ–º–∞', '‚è±Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ (–¥–æ–ø—É—Å–∫ 5—Å)', 'system');
            }
        }

        // –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function leaveRoom() {
            if (!currentUser.roomId) return;
            
            // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            if (syncCheckInterval) {
                clearInterval(syncCheckInterval);
                syncCheckInterval = null;
            }
            
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
            
            if (usersRef) {
                usersRef.child(currentUser.id).remove();
            }
            
            if (currentUser.isHost && roomRef) {
                roomRef.remove();
            }
            
            if (roomRef) roomRef.off();
            if (usersRef) usersRef.off();
            if (videoStateRef) videoStateRef.off();
            if (chatRef) chatRef.off();
            
            currentUser.roomId = null;
            currentUser.isHost = false;
            currentVideoData = null;
            
            createRoomBtn.disabled = false;
            joinRoomBtn.disabled = false;
            roomIdInput.disabled = false;
            leaveRoomBtn.style.display = 'none';
            roomInfo.style.display = 'none';
            chatInput.disabled = true;
            sendMessageBtn.disabled = true;
            
            videoPlayer.src = '';
            nativeVideo.src = '';
            nativePlayer.style.display = 'none';
            videoPlayer.style.display = 'block';
            currentVideoTitle.textContent = '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ';
            updateSyncProgress(0);
            
            addChatMessage('–°–∏—Å—Ç–µ–º–∞', 'üëã –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É', 'system');
        }

        // –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –æ–±–Ω–æ–≤–ª–µ–Ω —Å–ª—É—à–∞—Ç–µ–ª—å –≤–∏–¥–µ–æ
        function setupRoomListeners(roomId) {
            // –°–ª—É—à–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            usersRef.on('value', (snapshot) => {
                const users = snapshot.val() || {};
                const userCount = Object.keys(users).length;
                onlineCount.textContent = `${userCount} –æ–Ω–ª–∞–π–Ω`;
                
                let hostFound = false;
                guestBadge.style.display = 'none';
                
                Object.entries(users).forEach(([id, user]) => {
                    if (user.isHost) {
                        hostName.textContent = user.name;
                        hostFound = true;
                    } else {
                        guestName.textContent = user.name;
                        guestBadge.style.display = 'flex';
                    }
                });
                
                if (!hostFound && currentUser.roomId) {
                    alert('–•–æ—Å—Ç –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É');
                    leaveRoom();
                }
            });

            // –ò–ó–ú–ï–ù–ï–ù–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ –í–ò–î–ï–û
            videoStateRef.on('value', (snapshot) => {
                const videoData = snapshot.val();
                if (!videoData) return;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
                if (videoData.url && (!currentVideoTitle.textContent || currentVideoTitle.textContent === '–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ')) {
                    loadVideo(videoData.url, videoData.title);
                }
                
                // –•–æ—Å—Ç –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å –¥—Ä—É–≥–∏–º–∏
                if (currentUser.isHost) {
                    // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
                    if (videoElement) {
                        const percent = (videoElement.currentTime / videoElement.duration) * 100;
                        updateSyncProgress(percent);
                    }
                    return;
                }
                
                // –î–ª—è –Ω–µ-—Ö–æ—Å—Ç–∞ –≤—ã–∑—ã–≤–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é (–Ω–æ –æ–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å)
                syncVideoState(videoData);
            });

            // –°–ª—É—à–∞–µ–º —á–∞—Ç
            chatRef.limitToLast(50).on('child_added', (snapshot) => {
                const message = snapshot.val();
                if (message && message.userId !== currentUser.id) {
                    displayMessage(message);
                }
            });
        }

        // ==================== –ß–ê–¢ ====================
        function sendMessage(text) {
            if (!currentUser.roomId || !text.trim()) return;
            
            const message = {
                userId: currentUser.id,
                userName: currentUser.name,
                text: text.trim(),
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            chatRef.push(message).then(() => {
                displayMessage(message, true);
            });
            
            database.ref(`rooms/${currentUser.roomId}/typing`).remove();
        }

        function displayMessage(message, isOwn = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : (message.userId === 'system' ? 'system' : 'other')}`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (message.userId === 'system') {
                messageDiv.innerHTML = `
                    <div class="text">${message.text}</div>
                    <div class="time">${time}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="sender">${isOwn ? '–í—ã' : message.userName}</div>
                    <div class="text">${message.text}</div>
                    <div class="time">${time}</div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addChatMessage(sender, text, type = 'system') {
            displayMessage({
                userId: 'system',
                userName: sender,
                text: text
            });
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        updateConnectionStatus(true);

        database.ref('.info/connected').on('value', (snapshot) => {
            updateConnectionStatus(snapshot.val() === true);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        createRoomBtn.addEventListener('click', createRoom);
        
        joinRoomBtn.addEventListener('click', () => {
            const roomId = roomIdInput.value.trim().toUpperCase();
            if (roomId) {
                joinRoom(roomId);
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
            }
        });
        
        leaveRoomBtn.addEventListener('click', leaveRoom);
        
        copyRoomIdBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(currentRoomIdSpan.textContent).then(() => {
                alert('ID –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
            }).catch(() => {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID');
            });
        });

        loadUrlBtn.addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (url) {
                if (!currentUser.roomId) {
                    alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É');
                    return;
                }
                loadVideo(url);
                urlInput.value = '';
            }
        });

        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadUrlBtn.click();
        });

        syncNowBtn.addEventListener('click', () => {
            if (currentUser.roomId && videoStateRef && currentVideoData) {
                if (currentVideoData.type === 'direct' && videoElement) {
                    videoStateRef.update({
                        currentTime: videoElement.currentTime,
                        isPlaying: !videoElement.paused,
                        updatedBy: currentUser.id
                    });
                } else if (currentVideoData.type === 'rutube') {
                    getRutubeCurrentTime().then(time => {
                        videoStateRef.update({
                            currentTime: time,
                            isPlaying: true, // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —á—Ç–æ –∏–≥—Ä–∞–µ—Ç
                            updatedBy: currentUser.id
                        });
                    });
                }
                showSyncStatus(true);
            }
        });

        // –ß–∞—Ç
        sendMessageBtn.addEventListener('click', () => {
            sendMessage(chatInput.value);
            chatInput.value = '';
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(chatInput.value);
                chatInput.value = '';
            }
            
            if (currentUser.roomId) {
                database.ref(`rooms/${currentUser.roomId}/typing`).set({
                    userId: currentUser.id,
                    userName: currentUser.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                clearTimeout(window.typingTimeout);
                window.typingTimeout = setTimeout(() => {
                    database.ref(`rooms/${currentUser.roomId}/typing`).remove();
                }, 2000);
            }
        });

        window.addEventListener('beforeunload', () => {
            if (currentUser.roomId) {
                leaveRoom();
            }
        });

        addChatMessage('–°–∏—Å—Ç–µ–º–∞', 'üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'system');
    </script>
</body>
</html>